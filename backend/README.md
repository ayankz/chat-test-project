# Chat Backend

Бэкенд для чат-приложения с интеграцией OpenAI через WebSocket.

## Что умеет

- Стриминг ответов от OpenAI в реальном времени
- Хранит историю диалога (последние 20 сообщений)
- Rate limiting чтобы не спамили
- Валидация входящих данных
- Автоматический реконнект и обработка ошибок

## Структура

```
src/
├── config/          # Конфиги и env переменные
├── handlers/        # WebSocket обработчики
├── middleware/      # Rate limiter
├── routes/          # REST endpoints
├── services/        # OpenAI и логика чата
├── utils/           # Logger, валидация
└── server.js        # Главный файл
```

## Установка

```bash
npm install
```

Создай `.env` файл:
```bash
cp .env.example .env
```

Добавь свой OpenAI ключ в `.env`:
```
OPENAI_API_KEY=твой_ключ_тут
PORT=3001
NODE_ENV=development
RATE_LIMIT_MS=3000
MAX_HISTORY_LENGTH=20
```

## Запуск

Для разработки (с авто-перезагрузкой):
```bash
npm run dev
```

Для прода:
```bash
npm start
```

## API

### REST

- `GET /health` - проверка что сервер живой
- `GET /metrics` - статистика (активные соединения, память, аптайм)

### WebSocket

Подключайся к `ws://localhost:3001`

Отправить сообщение:
```json
{
  "type": "message",
  "content": "твое сообщение"
}
```

Получишь чанки стриминга:
```json
{
  "type": "chunk",
  "content": "токен"
}
```

Когда закончится:
```json
{
  "type": "done"
}
```

При ошибке:
```json
{
  "type": "error",
  "message": "описание ошибки"
}
```

## Переменные окружения

- `OPENAI_API_KEY` (обязательно) - API ключ OpenAI
- `PORT` (по дефолту 3001) - порт сервера
- `NODE_ENV` (по дефолту development) - окружение
- `RATE_LIMIT_MS` (по дефолту 3000) - задержка между запросами в мс
- `MAX_HISTORY_LENGTH` (по дефолту 20) - макс длина истории
- `OPENAI_MODEL` (по дефолту gpt-4o-mini) - какую модель юзать

## Основные фичи

**История диалога** - хранит контекст последних сообщений, чтобы бот понимал о чем речь

**Rate limiting** - защита от спама, между сообщениями должно пройти минимум 3 секунды

**Валидация** - проверяет что приходит правильный JSON, не пустое сообщение, не больше 10к символов

**Логирование** - структурированные логи с уровнями (ERROR, WARN, INFO, DEBUG)

**Graceful shutdown** - при остановке сервера корректно закрывает все соединения

## Мониторинг

Проверить здоровье сервера:
```bash
curl http://localhost:3001/health
```

Посмотреть метрики:
```bash
curl http://localhost:3001/metrics
```
